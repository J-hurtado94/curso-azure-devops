pool:
  name: Azure Pipelines
  demands:
  - msbuild
  - visualstudio

# Your build pipeline references the ‘BuildPlatform’ variable, which you’ve selected to be settable at queue time. 
# Create or edit the build pipeline for this YAML file, define the variable on the Variables tab, and then select the option to make it settable at queue time. 
# See https://go.microsoft.com/fwlink/?linkid=865971

# Your build pipeline references the ‘BuildConfiguration’ variable, which you’ve selected to be settable at queue time. 
# Create or edit the build pipeline for this YAML file, define the variable on the Variables tab, and then select the option to make it settable at queue time. 
# See https://go.microsoft.com/fwlink/?linkid=865971

variables:
  solution: 'KodotiAzureDevOpsProject.sln'
  BuildPlatform: 'Any CPU' 
  BuildConfiguration: 'Release'

jobs:
- job: Agente
  pool:
    vmImage: 'windows-latest'
    name: 'Azure Pipelines'
    demands:
    - msbuild
    - visualstudio
  steps:
  - task: NuGetToolInstaller@0
    displayName: 'Use NuGet'
    inputs:
      versionSpec: 4.4.1

  - task: NuGetCommand@2
    displayName: 'NuGet restore'
    inputs:
      restoreSolution: '$(solution)'

  - task: VSBuild@1
    displayName: 'Build solution'
    inputs:
      solution: '$(solution)'
      platform: '$(BuildPlatform)'
      configuration: '$(BuildConfiguration)'

  - task: VSTest@2
    displayName: 'Test Assemblies'
    inputs:
      testAssemblyVer2: |
        **\$(BuildConfiguration)\*Tests*.dll
        **\$(BuildConfiguration)\*.*Tests*.dll
        **\$(BuildConfiguration)\**\*Tests*.dll
        **\$(BuildConfiguration)\**\*.*Tests*.dll
        !**\obj\**
      platform: '$(BuildPlatform)'
      configuration: '$(BuildConfiguration)'
    enabled: false

  - task: CopyFiles@2
    displayName: 'Copy Files to: $(Build.ArtifactStagingDirectory)'
    inputs:
      SourceFolder: '$(Build.SourcesDirectory)'
      TargetFolder: '$(Build.ArtifactStagingDirectory)'

  - task: PublishSymbols@2
    displayName: 'Publish symbols path'
    inputs:
      SearchPattern: '**\bin\**\*.pdb'
      PublishSymbols: false
    continueOnError: true

  - task: PublishBuildArtifacts@1
    displayName: 'Publish Artifact'
    inputs:
      PathtoPublish: '$(Build.ArtifactStagingDirectory)'
      ArtifactName: 'drop'
    condition: succeededOrFailed()

- job: Agentes
  pool:
    vmImage: 'windows-latest'
    name: Azure Pipelines
    demands: vstest
  strategy:
    parallel: 3  # Configurar el número de agentes paralelos
  steps:
  - task: DownloadBuildArtifacts@1
    displayName: 'Download Build Artifacts'
    inputs:
      artifactName: drop
      extractTars: false

  - task: VSTest@3
    displayName: 'VsTest - testAssemblies'
